DECLARE
    v_job_id NUMBER := :P22_NEW_JOB_ID; -- your job ID page item
BEGIN
    -- Update detail table with values from PTS_CASE for VALID numeric entries
    MERGE INTO apex_mod.eres_bulk_res_upload_detail d
    USING (
        SELECT 
            TO_CHAR(p.pts_res_group_id) AS pts_res_group_id,
            p.mer_num,
            p.us_currency_amt,
            p.trn_dt,
            p.susp_reas_cd,
            p.work_of_dt,
            p.case_status_id,
            CASE 
                WHEN p.case_status_id = 20 THEN 'Already Closed'
                WHEN p.case_status_id = 10 THEN 'Resolution Pending'
                ELSE 'Scheduled'
            END AS status
        FROM eresuser_owner.pts_case p
    ) pts
    ON (
        TO_NUMBER(d.pts_res_group_id) = pts.pts_res_group_id
        AND d.job_id = v_job_id
        AND REGEXP_LIKE(d.pts_res_group_id, '^\d+$')
    )
    WHEN MATCHED THEN
        UPDATE SET
            d.row_status     = 'VALID',
            d.mer_num        = pts.mer_num,
            d.us_currency_amt= pts.us_currency_amt,
            d.trn_dt         = pts.trn_dt,
            d.susp_reas_cd   = pts.susp_reas_cd,
            d.work_of_dt     = pts.work_of_dt,
            d.case_status_id = pts.case_status_id,
            d.status         = pts.status
    WHEN NOT MATCHED THEN
        NULL;

    -- For all others, mark INVALID and clear details
    UPDATE apex_mod.eres_bulk_res_upload_detail d
       SET row_status     = 'INVALID',
           mer_num        = NULL,
           us_currency_amt= NULL,
           trn_dt         = NULL,
           susp_reas_cd   = NULL,
           work_of_dt     = NULL,
           case_status_id = NULL,
           status         = 'Invalid Record'
     WHERE d.job_id = v_job_id
       AND (NOT REGEXP_LIKE(d.pts_res_group_id, '^\d+$')
            OR NOT EXISTS (
                SELECT 1 FROM eresuser_owner.pts_case p
                 WHERE p.pts_res_group_id = TO_NUMBER(d.pts_res_group_id)
            ));

    COMMIT;

    DBMS_OUTPUT.PUT_LINE('Detail table updated successfully for job ID ' || v_job_id);
END;
/