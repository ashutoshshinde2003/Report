SELECT COUNT(*)
FROM (
  SELECT 
      br1.pts_res_group_id,
      DECODE(pts.case_status_id, 20, 'Bad', 'Good') AS status
  FROM apex_mod.eres_bulk_res_upload_detail br1
  JOIN eresuser_owner.pts_case pts
    ON TO_NUMBER(br1.pts_res_group_id) = pts.pts_res_group_id
  WHERE br1.job_id = :JOB_ID
    AND br1.row_status = 'VALID'
  GROUP BY br1.pts_res_group_id, pts.case_status_id
)
WHERE status = 'Good'




SELECT COUNT(*)
FROM (
  SELECT 
      br1.pts_res_group_id,
      DECODE(pts.case_status_id, 20, 'Bad', 'Good') AS status
  FROM apex_mod.eres_bulk_res_upload_detail br1
  JOIN eresuser_owner.pts_case pts
    ON TO_NUMBER(br1.pts_res_group_id) = pts.pts_res_group_id
  WHERE br1.job_id = :JOB_ID
    AND br1.row_status = 'VALID'
  GROUP BY br1.pts_res_group_id, pts.case_status_id
)
WHERE status = 'Bad'








SELECT 
    job_id,
    created_by,
    created_dt,
    job_status,

    CASE 
      WHEN job_status IN ('SCHEDULED','SUCCESSFUL','CANCELLED','FAILED') 
           AND job_status <> 'PENDING' THEN
        -- disabled button for completed/invalid states
        '<button class="t-Button t-Button--danger t-Button--small" disabled>Cancel</button>'
      ELSE
        -- active cancel button
        '<button class="t-Button t-Button--danger t-Button--small cancel-row" '||
        'data-jobid="'||job_id||'">Cancel</button>'
    END AS cancel_button

FROM apex_mod.eres_bulk_res_upload_smry
ORDER BY job_id DESC;





SELECT 
    -- Conditional Job ID (link or plain text)
    CASE 
      WHEN job_status IN ('CANCELLED','SUCCESSFUL') THEN 
        -- show plain job_id if cancelled/successful
        TO_CHAR(job_id)
      ELSE
        -- clickable link to preview page (replace 22 with your preview page number)
        '<a href="f?p=&APP_ID.:22:&SESSION.::NO::P22_JOB_ID:'||job_id||'" '||
        'class="t-Button t-Button--link">'||job_id||'</a>'
    END AS job_id_link,

    created_by,
    created_dt,
    job_status,

    -- Cancel button logic
    CASE 
      WHEN job_status IN ('SUCCESSFUL','CANCELLED','FAILED') THEN
        '<button class="t-Button t-Button--danger t-Button--small" disabled>Cancel</button>'
      ELSE
        '<button class="t-Button t-Button--danger t-Button--small cancel-row" '||
        'data-jobid="'||job_id||'">Cancel</button>'
    END AS cancel_button

FROM apex_mod.eres_bulk_res_upload_smry
ORDER BY job_id DESC;







/* ============================= */
/* VALID RECORDS (Static ID: VALID_RECORDS) */
/* ============================= */

/* Region header */
#VALID_RECORDS .t-Region-header { background-color:#28a745 !important; color:#fff !important; }
#VALID_RECORDS .t-Region-title  { color:#fff !important; }

/* Toolbar (search + go + actions) lives here */
#VALID_RECORDS_toolbar .a-IRR-search-field,
#VALID_RECORDS_toolbar input.a-IRR-searchField {
  width: 480px !important;
  height: 38px !important;
  font-size: 20px !important;
}

#VALID_RECORDS_toolbar .a-IRR-button.a-Button.a-IRR-button--go,
#VALID_RECORDS_toolbar .a-Button.a-IRR-button--go {
  height: 38px !important;
  font-size: 18px !important;  /* no space: 18px */
  padding: 0 20px !important;
  background-color: #007bff !important;
  color:#fff !important;
  border-radius:5px !important;
}

#VALID_RECORDS_toolbar .a-IRR-actions,
#VALID_RECORDS_toolbar .a-Toolbar-selectList,
#VALID_RECORDS_toolbar select.a-IRR-selectList {
  width: 160px !important;
  height: 38px !important;
  font-size: 18px !important;
}

/* Arrange toolbar neatly */
#VALID_RECORDS_toolbar .a-IRR-search,
#VALID_RECORDS_toolbar .a-Toolbar-group--search {
  display:flex !important;
  gap:16px !important;
  align-items:center !important;
}

/* Table body lives under _report */
#VALID_RECORDS_report .a-IRR-table tbody tr td { background:#e8f7ee !important; }
#VALID_RECORDS_report .a-IRR-table tbody tr:hover td { background:#c7f0d6 !important; }


/* ================================ */
/* INVALID RECORDS (Static ID: INVALID_RECORDS) */
/* ================================ */

/* Region header */
#INVALID_RECORDS .t-Region-header { background-color:#dc3545 !important; color:#fff !important; }
#INVALID_RECORDS .t-Region-title  { color:#fff !important; }

/* Toolbar */
#INVALID_RECORDS_toolbar .a-IRR-search-field,
#INVALID_RECORDS_toolbar input.a-IRR-searchField {
  width: 300px !important;
  height: 32px !important;
  font-size: 16px !important;
}

#INVALID_RECORDS_toolbar .a-IRR-button.a-Button.a-IRR-button--go,
#INVALID_RECORDS_toolbar .a-Button.a-IRR-button--go {
  height: 32px !important;
  font-size: 14px !important;
  padding: 0 16px !important;
  background-color:#dc3545 !important;
  color:#fff !important;
  border-radius:4px !important;
}

#INVALID_RECORDS_toolbar .a-IRR-actions,
#INVALID_RECORDS_toolbar .a-Toolbar-selectList,
#INVALID_RECORDS_toolbar select.a-IRR-selectList {
  width: 120px !important;
  height: 32px !important;
  font-size: 14px !important;
}

/* Arrange toolbar neatly */
#INVALID_RECORDS_toolbar .a-IRR-search,
#INVALID_RECORDS_toolbar .a-Toolbar-group--search {
  display:flex !important;
  gap:12px !important;
  align-items:center !important;
}

/* Table body */
#INVALID_RECORDS_report .a-IRR-table tbody tr td { background:#fdeaea !important; }
#INVALID_RECORDS_report .a-IRR-table tbody tr:hover td { background:#f9c7c7 !important; }





(function($){
  function tagIR(staticId, tag){
    // Add marker classes to toolbar/report if they exist
    $('#' + staticId + '_toolbar').addClass(tag + '-toolbar');
    $('#' + staticId + '_report').addClass(tag + '-report');
  }
  $(function(){
    tagIR('VALID_RECORDS','valid');
    tagIR('INVALID_RECORDS','invalid');
  });
})(apex.jQuery);







/* ============================= */
/* VALID RECORDS IR Styles */
/* ============================= */

/* Header bar */
#VALID_RECORDS .t-Region-header {
  background-color: #28a745 !important; /* green header */
  color: #fff !important;
}
#VALID_RECORDS .t-Region-title {
  color: #fff !important;
  font-weight: bold !important;
}

/* Toolbar */
.valid-toolbar .a-IRR-search-field {
  width: 480px !important;
  height: 38px !important;
  font-size: 20px !important;
}
.valid-toolbar .a-IRR-button--go {
  height: 38px !important;
  font-size: 18px !important;
  padding: 0 20px !important;
  background-color: #007bff !important; /* blue button */
  color: #fff !important;
  border-radius: 5px !important;
}
.valid-toolbar .a-IRR-actions,
.valid-toolbar select.a-IRR-selectList {
  width: 160px !important;
  height: 38px !important;
  font-size: 18px !important;
}
.valid-toolbar .a-IRR-search {
  display: flex !important;
  gap: 16px !important;
  align-items: center !important;
}

/* Table rows */
.valid-report .a-IRR-table tbody tr td {
  background-color: #e8f7ee !important; /* light green */
}
.valid-report .a-IRR-table tbody tr:hover td {
  background-color: #c7f0d6 !important; /* darker green on hover */
}


/* ================================ */
/* INVALID RECORDS IR Styles */
/* ================================ */

/* Header bar */
#INVALID_RECORDS .t-Region-header {
  background-color: #dc3545 !important; /* red header */
  color: #fff !important;
}
#INVALID_RECORDS .t-Region-title {
  color: #fff !important;
  font-weight: bold !important;
}

/* Toolbar */
.invalid-toolbar .a-IRR-search-field {
  width: 300px !important;
  height: 32px !important;
  font-size: 16px !important;
}
.invalid-toolbar .a-IRR-button--go {
  height: 32px !important;
  font-size: 14px !important;
  padding: 0 16px !important;
  background-color: #dc3545 !important; /* red button */
  color: #fff !important;
  border-radius: 4px !important;
}
.invalid-toolbar .a-IRR-actions,
.invalid-toolbar select.a-IRR-selectList {
  width: 120px !important;
  height: 32px !important;
  font-size: 14px !important;
}
.invalid-toolbar .a-IRR-search {
  display: flex !important;
  gap: 12px !important;
  align-items: center !important;
}

/* Table rows */
.invalid-report .a-IRR-table tbody tr td {
  background-color: #fdeaea !important; /* light red */
}
.invalid-report .a-IRR-table tbody tr:hover td {
  background-color: #f9c7c7 !important; /* darker red on hover */
}






/* ============================= */
/* VALID RECORDS (green rows) */
/* ============================= */

/* Region header */
#VALID_RECORDS .t-Region-header {
  background-color: #28a745 !important;  /* green */
  color: #fff !important;
}
#VALID_RECORDS .t-Region-title {
  color: #fff !important;
  font-weight: bold !important;
}

/* Data rows */
#VALID_RECORDS_report .a-IRR-table tbody tr td {
  background-color: #e8f7ee !important;  /* light green */
}
#VALID_RECORDS_report .a-IRR-table tbody tr:hover td {
  background-color: #c7f0d6 !important;  /* darker green on hover */
}


/* ================================ */
/* INVALID RECORDS (red rows) */
/* ================================ */

/* Region header */
#INVALID_RECORDS .t-Region-header {
  background-color: #dc3545 !important;  /* red */
  color: #fff !important;
}
#INVALID_RECORDS .t-Region-title {
  color: #fff !important;
  font-weight: bold !important;
}

/* Data rows */
#INVALID_RECORDS_report .a-IRR-table tbody tr td {
  background-color: #fdeaea !important;  /* light red */
}
#INVALID_RECORDS_report .a-IRR-table tbody tr:hover td {
  background-color: #f9c7c7 !important;  /* darker red on hover */
}










  

SELECT 
    d.pts_res_group_id,
    MAX(p.mer_num) AS mer_num,
    SUM(p.us_currency_amt) AS us_currency_amt,
    MAX(p.trn_dt) AS trn_dt,
    MAX(p.susp_reas_cd) AS susp_reas_cd,
    MAX(p.work_of_dt) AS work_of_dt,
    MAX(p.case_status_id) AS case_status_id,
    DECODE(MAX(p.case_status_id), 20, 'Already Closed', 'Scheduled') AS status,

    -- Row style for valid records
    'background-color:#e8f7ee;' AS row_style

FROM apex_mod.eres_bulk_res_upload_detail d
JOIN eresuser_owner.pts_case p
  ON d.pts_res_group_id = p.pts_res_group_id
WHERE d.job_id = :P23_JOB_ID
  AND REGEXP_LIKE(d.pts_res_group_id, '^\d+$') -- only numeric
GROUP BY d.pts_res_group_id
ORDER BY MAX(p.work_of_dt) DESC;




SELECT 
    d.pts_res_group_id,
    d.job_id,
    d.seq_no,

    CASE 
      WHEN d.pts_res_group_id IS NULL 
        OR NOT REGEXP_LIKE(d.pts_res_group_id, '^\d+$')
        OR NOT EXISTS (SELECT 1 
                       FROM eresuser_owner.pts_case p 
                       WHERE p.pts_res_group_id = d.pts_res_group_id)
      THEN 'Invalid'
    END AS status,

    -- Row style for invalid records
    'background-color:#fdeaea;' AS row_style

FROM apex_mod.eres_bulk_res_upload_detail d
WHERE d.job_id = :P23_JOB_ID
  AND (
        d.pts_res_group_id IS NULL
     OR NOT REGEXP_LIKE(d.pts_res_group_id, '^\d+$')
     OR NOT EXISTS (SELECT 1 
                    FROM eresuser_owner.pts_case p 
                    WHERE p.pts_res_group_id = d.pts_res_group_id)
  )
ORDER BY d.seq_no;



























CREATE OR REPLACE PROCEDURE ERESUSER_OWNER.AUTO_DNP
IS
    /*********************************************************************************
    1.0         Ashutosh                Created this proc for auto DNP from Apex
    *********************************************************************************/
    
    cnt number:= 0;
    CURSOR c1 IS
        SELECT DISTINCT brd.PTS_RES_GROUP_ID, pc.QUEUE_ID
         FROM apex_mod.bulk_resolution_data1 brd, ERESUSER_OWNER.PTS_CASE pc
         where brd.pts_res_group_id = pc.pts_res_group_id
	 and pc.case_status_id not in (20);
         
BEGIN
    FOR i IN c1
    LOOP
        cnt := cnt + 1;

        UPDATE ERESUSER_OWNER.PTS_BATCH_RESOLUTION
           SET ACTION_ID = 1179,
               SUSP_COMMENT_ID = 8,
               RES_DT = TRUNC (SYSDATE),
               USER_NAME = 'SYSTEM',
               PTS_GRP_NOTE = 'Auto-DNP Bulk Resolution performed' -- Add job id and bulk resolution performed
         WHERE PTS_RES_Group_id = i.pts_res_group_id;

        UPDATE ERESUSER_OWNER.PTS_CASE
           SET CASE_STATUS_ID = 20, CLOSED_DT = TRUNC (SYSDATE)
         WHERE PTS_RES_Group_id = i.pts_res_group_id;

        INSERT INTO ERESUSER_OWNER.PTS_BATCH_ACTION (CASE_ACTION_ID,
                                      PTS_RES_GROUP_ID,
                                      ACTION_ID,
                                      CREATED_DT,
                                      USER_COMMENT,
                                      USER_NAME,
                                      PRIOR_QUEUE_ID)
             VALUES (SEQ_PTS_CASE_ACTION_ID.NEXTVAL,
                     i.PTS_RES_GROUP_ID,
                     1179,
                     SYSDATE,
                     'Auto-DNP Bulk Resolution performed', -- Add job id and bulk resolution performed
                     'SYSTEM',
                     i.QUEUE_ID);


        IF cnt = 1000
        THEN
            COMMIT;
            cnt := 0;
        END IF;
    END LOOP;

    COMMIT;
    
    cnt := cnt + 1;
    DBMS_OUTPUT.PUT_LINE ('Total Records: ' || cnt);
EXCEPTION
    WHEN OTHERS
    THEN
        DBMS_OUTPUT.PUT_LINE ('ERROR: ' || SQLERRM);
END;
/








BEGIN
    DBMS_SCHEDULER.create_job (
        job_name        => 'AUTO_DNP_NIGHTLY_RUN',  -- unique name for your job
        job_type        => 'PLSQL_BLOCK',           -- we’re running PL/SQL
        job_action      => 'BEGIN apex_mod.run_auto_dnp_scheduled; END;',
        start_date      => SYSTIMESTAMP,            -- start immediately (first run)
        repeat_interval => 'FREQ=DAILY; BYHOUR=2; BYMINUTE=15; BYSECOND=0',
        enabled         => TRUE,                    -- start scheduling right away
        comments        => 'Runs AUTO_DNP procedure nightly and updates job statuses.'
    );
END;
/