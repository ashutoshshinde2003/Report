INSERT INTO bulk_resolution_data (job_id, submission, date_added, status, user_added)
VALUES (
  bulk_resolution_seq.NEXTVAL,
  :P1_SUBMISSION,
  SYSDATE,
  'SUCCESSFUL',
  :APP_USER
);


DECLARE
    l_blob       BLOB;
    l_file_name  VARCHAR2(255);
BEGIN
    -- get latest uploaded file
    SELECT blob_content, filename
      INTO l_blob, l_file_name
      FROM (
             SELECT blob_content, filename
               FROM apex_application_temp_files
              WHERE application_id = :APP_ID
              ORDER BY created_on DESC
           )
     WHERE ROWNUM = 1;

    -- parse second sheet (Cases)
    FOR rec IN (
        SELECT *
          FROM TABLE(
                 apex_data_parser.parse(
                     p_content    => l_blob,
                     p_file_name  => l_file_name,
                     
                     p_skip_rows  => 1
                 )
               )
    )
    LOOP
        INSERT INTO bulk_resolution_data1 (
            case_id,
            job_id,
            status,
            case_status
        )
        VALUES (
            rec.col001,  -- adjust mapping as per your Excel columns
            rec.col002,
            rec.col003,
            rec.col004
        );
    END LOOP;

    DELETE FROM apex_application_temp_files
     WHERE filename = l_file_name;

    COMMIT;
END;




DECLARE
    l_blob       BLOB;
    l_file_name  VARCHAR2(255);
    l_job_id     NUMBER;
BEGIN
    -- 1. Generate new JOB_ID by inserting into bulk_resolution_data
    INSERT INTO bulk_resolution_data (
        job_id,
        submission,
        date_added,
        status,
        user_added
    ) VALUES (
        bulk_resolution_seq.NEXTVAL,
        :P1_SUBMISSION,
        SYSDATE,
        'SUCCESSFUL',
        :APP_USER
    )
    RETURNING job_id INTO l_job_id;  -- store generated job_id

    -- 2. Get the latest uploaded file from APEX temp files
    SELECT blob_content, filename
      INTO l_blob, l_file_name
      FROM (
             SELECT blob_content, filename
               FROM apex_application_temp_files
              WHERE application_id = :APP_ID
              ORDER BY created_on DESC
           )
     WHERE ROWNUM = 1;

    -- 3. Parse the Excel and insert into bulk_resolution_data1
    FOR rec IN (
        SELECT *
          FROM TABLE(
                 apex_data_parser.parse(
                     p_content    => l_blob,
                     p_file_name  => l_file_name,
                     p_skip_rows  => 1   -- skip header row
                 )
               )
    )
    LOOP
        INSERT INTO bulk_resolution_data1 (
            case_id,
            job_id,
            status,
            case_status
        )
        VALUES (
            rec.col001,   -- Excel col1 -> case_id
            l_job_id,     -- use same job_id from bulk_resolution_data
            rec.col002,   -- Excel col2 -> status
            rec.col003    -- Excel col3 -> case_status
        );
    END LOOP;

    -- 4. Delete uploaded file from temp storage
    DELETE FROM apex_application_temp_files
     WHERE filename = l_file_name;

    COMMIT;
END;